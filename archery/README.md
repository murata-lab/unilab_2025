# 弓矢ゲーム

脳波を利用した弓矢の的あてゲームです。集中度に応じて照準の精度が変化し、リアルタイムで脳波データを可視化します。

## 機能

- **脳波測定**: OpenBCI Ganglionボードを使用したリアルタイム脳波測定
- **集中度連動**: 脳波のα波/β波比率に応じて照準の精度が変化
- **ゲームモード**: ふつうモードとむずかしいモード
- **カウントダウン**: 各ラウンド前に「3, 2, 1」カウントダウン
- **プレイヤー名設定**: 日本語入力対応の名前設定機能
- **Webランキングシステム**: スコアの保存とランキング表示
- **音声効果**: BGM、矢を打つ音、矢が刺さる音

## 必要な環境

- Python 3.9以上
- OpenBCI Ganglionボード
- 音声ファイル（MP3形式）

### 新しいパソコンでのセットアップ手順
**重要**: Python 3.9以上が必要です（requirements.txtの依存関係のため）

1. **Python環境の準備**
   ```bash
   # Python 3.9以上をインストール（requirements.txtの依存関係のため）
   # condaを使用する場合
   conda create -n archery-game python=3.9
   conda activate archery-game
   
   # または、venvを使用する場合
   python -m venv archery-game
   source archery-game/bin/activate  # macOS/Linux
   # archery-game\Scripts\activate  # Windows
   ```

2. **依存関係のインストール**
   ```bash
   pip install -r requirements.txt
   ```


## 使用方法

### 1. Webサーバーの起動

```bash
python web_server.py
```

ブラウザで `http://localhost:5000` にアクセスしてランキングを確認できます。

### 2. ゲームの起動

```bash
python main.py
```

### 3. ゲームの流れ

1. **スタート画面** → スペースキー
2. **プレイヤー名入力** → 文字入力（日本語対応）、Enterキーで確定
3. **モード選択** → 上下キーで選択、スペースキーで決定
4. **カウントダウン**（3, 2, 1）
5. **ゲームプレイ**（10秒間）
6. **結果表示** → スペースキー
7. **3回繰り返し**
8. **最終結果画面** → Rキーでランキング送信、スペースキーでスタート画面に戻る

## ゲームモード

### ふつうモード
- 標準的な的のサイズ
- 通常の照準の揺れ
- 風の影響なし
- 脳波の影響は標準レベル

### むずかしいモード
- 的が小さくなる（70%サイズ）
- 照準の揺れが強くなる（1.5倍）
- 風の影響が追加される
- 脳波の影響がより強く反映される
- 得点範囲も小さくなる

## 操作説明

### 名前入力画面
- **文字入力**: 直接タイプして文字を追加
- **Backspace**: 最後の文字を削除
- **Enter**: 名前確定

### モード選択画面
- **上下キー**: モード選択
- **スペースキー**: 決定

### ゲームプレイ中
- **スペースキー**: 手動で矢を打つ
- **自動発射**: 10秒経過で自動発射

## ファイル構成

- `main.py` - メインゲーム（脳波測定、ゲームロジック）
- `web_server.py` - Webサーバー（ランキング機能）
- `templates/index.html` - ランキング表示ページ
- `ranking.json` - ランキングデータ（自動生成）
- `requirements.txt` - 依存関係


## 重要な設定と注意事項

### USBポート設定
- **Windows**: `main.py`の`serial_port`を`"COM3"`に設定（必要に応じて変更）
- **Mac**: 正常に動作しない可能性があります。Macでの使用は推奨されません
- **Linux**: `/dev/ttyUSB0`などの形式で設定

### 環境変更時の注意
背景画像のサイズを変更など環境の変更を伴う場合は、`main.py`の691行目付近にある以下のコードも調整が必要です：

```python
min_aim_radius = initial_min + 130 * current_ratio
```

この係数（130）は適宜調整しないと脳波によって照準が広がらなくなってしまう可能性があります

### 脳波測定の設定
- **サンプリングレート**: 200Hz
- **チャンネル数**: 4チャンネル
- **フィルタリング**: 移動平均フィルタ適用
- **リアルタイム可視化**: matplotlibによるグラフ表示

### その他の注意事項
- OpenBCI Ganglionボードが正しく接続されている必要があります
- 音声ファイルが見つからない場合は音声なしで実行されます
- Webサーバーが起動していない場合、ランキング送信は失敗します
- 脳波測定中は別ウィンドウでリアルタイムグラフが表示されます

## トラブルシューティング

### 脳波測定が開始されない
1. USBポートの設定を確認
2. OpenBCI Ganglionボードの接続を確認
3. ドライバーが正しくインストールされているか確認

### ランキング送信が失敗する
1. Webサーバーが起動しているか確認
2. `http://localhost:5000`にアクセスしてサーバーが応答するか確認

### 音声が再生されない
1. 音声ファイルが正しい場所にあるか確認
2. ファイル名が正確か確認

## 技術仕様

### 使用ライブラリ
- **pygame**: ゲームエンジン
- **brainflow**: 脳波データ処理
- **matplotlib**: リアルタイムグラフ表示
- **flask**: Webサーバー
- **requests**: HTTP通信
- **numpy**: 数値計算

### 脳波処理
- **α波/β波比率**: 集中度の指標として使用
- **移動平均フィルタ**: ノイズ除去
- **リアルタイム処理**: 30ms間隔で更新 